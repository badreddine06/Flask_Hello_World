name: Flask Ngrok Preview

on:
  workflow_dispatch:

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Set up Ngrok auth token
      run: |
        pip install pyngrok
        python -c "from pyngrok import ngrok; ngrok.set_auth_token('${{ secrets.NGROK_AUTHTOKEN }}')"

    - name: Start Flask in background
      run: |
        nohup python -m flask run --host=0.0.0.0 --port=5000 &

    - name: Expose with Ngrok for 120 seconds
      run: |
        python -c "from pyngrok import ngrok; import time
url = ngrok.connect(5000)
print('ðŸ”— URL ngrok:', url)
time.sleep(120)"
